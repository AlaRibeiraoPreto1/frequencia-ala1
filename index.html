<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Frequ√™ncia Pro - Ala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f1f5f9; }
        .hidden { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .filter-pill.active { background-color: #002e5d; color: white; border-color: #002e5d; }
        input[type="checkbox"] { width: 1.5rem; height: 1.5rem; }
    </style>
</head>
<body class="font-sans pb-24">

    <!-- Header -->
    <header class="bg-[#002e5d] text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold italic leading-tight">Frequ√™ncia Ala</h1>
                <select id="dateSelect" class="bg-transparent text-[10px] uppercase font-bold outline-none border-none"></select>
            </div>
            <div id="connection-status" class="text-[10px] bg-red-500 px-2 py-1 rounded font-bold uppercase tracking-tighter">Conectando...</div>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-md">
        
        <!-- Tela de Login -->
        <div id="view-login" class="py-10 text-center">
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <i class="fas fa-shield-halved text-5xl text-[#002e5d] mb-4"></i>
                <h2 class="text-xl font-bold mb-6 text-gray-800">Acesso Restrito</h2>
                <input type="password" id="access-code" placeholder="C√≥digo da Ala" class="w-full p-4 border rounded-xl mb-4 text-center text-3xl outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="checkLogin()" class="w-full bg-[#002e5d] text-white p-4 rounded-xl font-bold active:scale-95 transition-transform">Entrar</button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="view-dashboard" class="hidden space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-5 rounded-2xl shadow-sm border-b-4 border-green-500 text-center">
                    <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest">Presentes</p>
                    <p id="stats-present" class="text-4xl font-black text-green-600">0</p>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border-b-4 border-blue-800 text-center">
                    <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest">Membros Ala</p>
                    <p id="stats-total" class="text-4xl font-black text-[#002e5d]">0</p>
                </div>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm overflow-hidden">
                <h3 class="text-[10px] font-bold text-gray-400 uppercase mb-4 text-center tracking-widest">Tend√™ncia de Frequ√™ncia</h3>
                <canvas id="attendanceChart" height="150"></canvas>
            </div>

            <div class="flex gap-2">
                <button onclick="exportData()" class="flex-1 bg-white border p-3 rounded-xl text-[10px] font-bold text-gray-600 uppercase"><i class="fas fa-file-export mr-2"></i>Backup</button>
                <button onclick="window.print()" class="flex-1 bg-white border p-3 rounded-xl text-[10px] font-bold text-gray-600 uppercase"><i class="fas fa-print mr-2"></i>Imprimir</button>
            </div>
        </div>

        <!-- Lista de Frequ√™ncia -->
        <div id="view-attendance" class="hidden space-y-4">
            <div class="flex overflow-x-auto gap-2 pb-2 no-scrollbar">
                <button onclick="setFilter('TODOS')" class="filter-pill active px-4 py-2 rounded-full border bg-white text-[10px] font-bold" id="pill-TODOS">TODOS</button>
                <button onclick="setFilter('√âLDERES')" class="filter-pill px-4 py-2 rounded-full border bg-white text-[10px] font-bold" id="pill-√âLDERES">√âLDERES</button>
                <button onclick="setFilter('SOCORRO')" class="filter-pill px-4 py-2 rounded-full border bg-white text-[10px] font-bold" id="pill-SOCORRO">SOCORRO</button>
                <button onclick="setFilter('MO√áAS')" class="filter-pill px-4 py-2 rounded-full border bg-white text-[10px] font-bold" id="pill-MO√áAS">MO√áAS</button>
                <button onclick="setFilter('RAPAZES')" class="filter-pill px-4 py-2 rounded-full border bg-white text-[10px] font-bold" id="pill-RAPAZES">RAPAZES</button>
                <button onclick="setFilter('PRIM√ÅRIA')" class="filter-pill px-4 py-2 rounded-full border bg-white text-[10px] font-bold" id="pill-PRIM√ÅRIA">PRIM√ÅRIA</button>
                <button onclick="setFilter('VISITANTE')" class="filter-pill px-4 py-2 rounded-full border bg-white text-[10px] font-bold" id="pill-VISITANTE">VISITANTES</button>
            </div>

            <input type="text" id="searchMember" placeholder="üîç Buscar nome..." class="w-full p-4 border rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
            
            <div id="memberList" class="space-y-2"></div>
        </div>

        <!-- Lista de Resgate -->
        <div id="view-analysis" class="hidden space-y-4">
            <h2 class="text-center font-bold text-orange-600 uppercase text-xs tracking-widest">Ausentes h√° +3 Semanas</h2>
            <div id="missingList" class="space-y-3"></div>
        </div>

        <!-- Novo Membro -->
        <div id="view-add" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-sm border space-y-4">
                <h2 class="font-bold text-center uppercase text-sm tracking-widest">Novo Registro</h2>
                <input type="text" id="newName" placeholder="NOME COMPLETO" class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 uppercase">
                <select id="newOrg" class="w-full p-4 border rounded-xl outline-none bg-gray-50 text-sm">
                    <option value="√âLDERES">QU√ìRUM DE √âLDERES</option>
                    <option value="SOCORRO">SOCIEDADE DE SOCORRO</option>
                    <option value="MO√áAS">MO√áAS</option>
                    <option value="RAPAZES">RAPAZES</option>
                    <option value="PRIM√ÅRIA">PRIM√ÅRIA</option>
                    <option value="VISITANTE">VISITANTE (N√ÉO √â DA ALA)</option>
                </select>
                <button onclick="addMember()" class="w-full bg-[#002e5d] text-white p-4 rounded-xl font-bold active:scale-95 transition-transform">CADASTRAR</button>
            </div>
        </div>

        <!-- Modal de Edi√ß√£o -->
        <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 space-y-4">
                <div class="flex justify-between items-center border-b pb-2">
                    <h3 class="font-bold text-gray-800 uppercase text-sm">Editar Registro</h3>
                    <button onclick="closeEditModal()"><i class="fas fa-times text-gray-400"></i></button>
                </div>
                <input type="text" id="editName" class="w-full p-3 border rounded-xl uppercase">
                <select id="editOrg" class="w-full p-3 border rounded-xl bg-gray-50">
                    <option value="√âLDERES">√âLDERES</option>
                    <option value="SOCORRO">SOCORRO</option>
                    <option value="MO√áAS">MO√áAS</option>
                    <option value="RAPAZES">RAPAZES</option>
                    <option value="PRIM√ÅRIA">PRIM√ÅRIA</option>
                    <option value="VISITANTE">VISITANTE</option>
                </select>
                <div class="flex gap-2 pt-2">
                    <button onclick="deleteMember()" class="flex-1 bg-red-100 text-red-600 p-3 rounded-xl font-bold text-xs"><i class="fas fa-trash mr-2"></i>EXCLUIR</button>
                    <button onclick="saveEdit()" class="flex-[2] bg-[#002e5d] text-white p-3 rounded-xl font-bold text-xs">SALVAR ALTERA√á√ïES</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Menu Superior -->
    <nav id="nav-bar" class="hidden fixed bottom-0 w-full bg-white border-t flex justify-around py-3 px-2 shadow-2xl z-50">
        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="flex flex-col items-center gap-1 text-gray-400"><i class="fas fa-home text-xl"></i><span class="text-[10px]">In√≠cio</span></button>
        <button onclick="switchTab('attendance')" id="nav-attendance" class="flex flex-col items-center gap-1 text-gray-400"><i class="fas fa-check-double text-xl"></i><span class="text-[10px]">Chamada</span></button>
        <button onclick="switchTab('analysis')" id="nav-analysis" class="flex flex-col items-center gap-1 text-gray-400"><i class="fas fa-heart-pulse text-xl"></i><span class="text-[10px]">Resgate</span></button>
        <button onclick="switchTab('add')" id="nav-add" class="flex flex-col items-center gap-1 text-gray-400"><i class="fas fa-plus-circle text-xl"></i><span class="text-[10px]">Novo</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAaEKx9n4N847WW97FhfZxLZYtsa5cTsE0",
          authDomain: "frequencia-da-ala.firebaseapp.com",
          projectId: "frequencia-da-ala",
          storageBucket: "frequencia-da-ala.firebasestorage.app",
          messagingSenderId: "823110082594",
          appId: "1:823110082594:web:525d38b65a5ab74ec9ea7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let members = [];
        let attendanceHistory = {};
        let currentFilter = 'TODOS';
        let chartInstance = null;
        let selectedDate = new Date().toISOString().split('T')[0];
        let memberToEdit = null;

        // Gerar seletor de domingos
        const dateSelect = document.getElementById('dateSelect');
        for(let i=0; i<8; i++) {
            let d = new Date();
            d.setDate(d.getDate() - (d.getDay() + (7 * i)) % 56);
            let iso = d.toISOString().split('T')[0];
            dateSelect.innerHTML += `<option value="${iso}">${i==0 ? 'DOMINGO HOJE' : 'DOMINGO '+iso.split('-')[2]+'/'+iso.split('-')[1]}</option>`;
        }
        selectedDate = dateSelect.value;

        window.checkLogin = () => {
            if(document.getElementById('access-code').value === "1234") {
                localStorage.setItem('auth_ala_v4', 'ok');
                startApp();
            } else { alert("C√≥digo incorreto!"); }
        };

        function startApp() {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('nav-bar').classList.remove('hidden');
            switchTab('dashboard');
            listenData();
        }

        function listenData() {
            onSnapshot(query(collection(db, "membros"), orderBy("name")), (snap) => {
                members = snap.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });
            onSnapshot(collection(db, "historico"), (snap) => {
                attendanceHistory = {};
                snap.docs.forEach(d => attendanceHistory[d.id] = d.data().presents || []);
                updateChart();
                render();
            });
            document.getElementById('connection-status').innerText = "ONLINE";
            document.getElementById('connection-status').classList.replace('bg-red-500', 'bg-green-600');
        }

        window.togglePresence = async (memberId) => {
            const histRef = doc(db, "historico", selectedDate);
            let currentPresents = attendanceHistory[selectedDate] || [];
            if(currentPresents.includes(memberId)) {
                currentPresents = currentPresents.filter(id => id !== memberId);
            } else {
                currentPresents.push(memberId);
                await updateDoc(doc(db, "membros", memberId), { lastAttended: selectedDate });
            }
            await setDoc(histRef, { presents: currentPresents });
        };

        window.addMember = async () => {
            const name = document.getElementById('newName').value.trim().toUpperCase();
            const org = document.getElementById('newOrg').value;
            if(!name) return;
            await addDoc(collection(db, "membros"), { name, org, lastAttended: "2024-01-01" });
            document.getElementById('newName').value = "";
            switchTab('attendance');
        };

        // FUN√á√ïES DE EDI√á√ÉO E EXCLUS√ÉO
        window.openEditModal = (id) => {
            memberToEdit = members.find(m => m.id === id);
            document.getElementById('editName').value = memberToEdit.name;
            document.getElementById('editOrg').value = memberToEdit.org || '√âLDERES';
            document.getElementById('editModal').classList.remove('hidden');
        };

        window.closeEditModal = () => {
            document.getElementById('editModal').classList.add('hidden');
            memberToEdit = null;
        };

        window.saveEdit = async () => {
            if(!memberToEdit) return;
            const newName = document.getElementById('editName').value.trim().toUpperCase();
            const newOrg = document.getElementById('editOrg').value;
            await updateDoc(doc(db, "membros", memberToEdit.id), { name: newName, org: newOrg });
            closeEditModal();
        };

        window.deleteMember = async () => {
            if(!memberToEdit) return;
            if(confirm(`Tem certeza que deseja excluir ${memberToEdit.name}? Todos os registros dele ser√£o apagados.`)) {
                await deleteDoc(doc(db, "membros", memberToEdit.id));
                closeEditModal();
            }
        };

        function render() {
            const search = document.getElementById('searchMember').value.toLowerCase();
            const list = document.getElementById('memberList');
            const missingList = document.getElementById('missingList');
            const presentsToday = attendanceHistory[selectedDate] || [];

            list.innerHTML = '';
            missingList.innerHTML = '';
            let countPresent = 0; let countTotal = 0;

            members.forEach(m => {
                const isPresent = presentsToday.includes(m.id);
                if(m.org !== 'VISITANTE') { countTotal++; if(isPresent) countPresent++; }

                const diff = Math.floor((new Date() - new Date(m.lastAttended)) / (1000*60*60*24));
                if(m.org !== 'VISITANTE' && diff > 21) {
                    missingList.innerHTML += `
                        <div class="bg-white p-4 rounded-xl border-r-4 border-orange-500 flex justify-between items-center shadow-sm">
                            <div><p class="font-bold text-sm text-gray-800">${m.name}</p><p class="text-[9px] text-orange-600 font-bold">${m.org} ‚Ä¢ ${Math.floor(diff/7)} SEMANAS</p></div>
                            <a href="https://wa.me/?text=Ol√° ${m.name.split(' ')[0]}, sentimos sua falta!" class="text-green-500 text-xl"><i class="fab fa-whatsapp"></i></a>
                        </div>
                    `;
                }

                if((currentFilter === 'TODOS' || m.org === currentFilter) && m.name.toLowerCase().includes(search)) {
                    list.innerHTML += `
                        <div class="flex items-center gap-3 bg-white p-4 rounded-xl shadow-sm border-l-4 ${isPresent ? 'border-green-500' : 'border-gray-200'}">
                            <input type="checkbox" ${isPresent ? 'checked' : ''} onchange="togglePresence('${m.id}')" class="rounded-full text-blue-900">
                            <div onclick="togglePresence('${m.id}')" class="flex-1">
                                <p class="font-bold text-sm text-gray-700 leading-tight">${m.name}</p>
                                <p class="text-[9px] text-gray-400 font-bold uppercase">${m.org}</p>
                            </div>
                            <button onclick="openEditModal('${m.id}')" class="text-gray-300 hover:text-blue-900 px-2"><i class="fas fa-edit text-sm"></i></button>
                        </div>
                    `;
                }
            });
            document.getElementById('stats-present').innerText = countPresent;
            document.getElementById('stats-total').innerText = countTotal;
        }

        function updateChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            const dates = Object.keys(attendanceHistory).sort().slice(-5);
            const counts = dates.map(d => attendanceHistory[d].length);
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(d => d.split('-')[2]+'/'+d.split('-')[1]),
                    datasets: [{ data: counts, borderColor: '#002e5d', backgroundColor: 'rgba(0,46,93,0.1)', fill: true, tension: 0.4 }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        window.setFilter = (f) => {
            currentFilter = f;
            document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
            document.getElementById('pill-'+f).classList.add('active');
            render();
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('text-[#002e5d]', 'text-gray-400'));
            document.getElementById(`nav-${tab}`).classList.replace('text-gray-400', 'text-[#002e5d]');
        };

        window.exportData = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({members, attendanceHistory}));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup_ala.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        dateSelect.addEventListener('change', (e) => { selectedDate = e.target.value; render(); });
        document.getElementById('searchMember').addEventListener('input', render);

        if(localStorage.getItem('auth_ala_v4')) startApp();
    </script>
</body>
</html>
