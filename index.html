<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Frequ√™ncia Sacramental</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        .hidden { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .filter-pill.active { background-color: #002e5d; color: white; border-color: #002e5d; }
        #side-menu { transition: transform 0.3s ease-in-out; }
        .menu-open { transform: translateX(0) !important; }
        .report-card { border-left: 4px solid #002e5d; }
    </style>
</head>
<body class="font-sans pb-24 text-gray-800">

    <!-- Header -->
    <header class="bg-[#002e5d] text-white p-4 shadow-lg sticky top-0 z-[60]">
        <div class="container mx-auto flex justify-between items-center">
            <div id="header-info" class="hidden">
                <p class="text-[10px] opacity-70 uppercase tracking-widest font-bold">Ol√°, <span id="user-first-name">...</span></p>
                <h1 class="text-base font-bold italic leading-tight">Frequ√™ncia Sacramental</h1>
            </div>
            <div id="header-login-title" class="font-bold italic">Frequ√™ncia Sacramental</div>
            <button onclick="toggleMenu()" id="menu-btn" class="hidden p-2"><i class="fas fa-bars text-xl"></i></button>
        </div>
    </header>

    <!-- Menu Lateral -->
    <div id="menu-overlay" onclick="toggleMenu()" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[70]"></div>
    <div id="side-menu" class="fixed top-0 right-0 w-64 h-full bg-white z-[80] shadow-2xl transform translate-x-full flex flex-col">
        <div class="p-6 bg-[#002e5d] text-white">
            <p id="menu-user-name" class="font-bold">Usu√°rio</p>
            <p id="menu-user-role" class="text-[10px] opacity-70 uppercase tracking-widest"></p>
        </div>
        <div class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchTab('dashboard')" class="w-full text-left p-3 hover:bg-gray-100 rounded-xl text-sm"><i class="fas fa-chart-line mr-3 text-blue-900"></i>Painel de An√°lise</button>
            <button onclick="switchTab('attendance')" class="w-full text-left p-3 hover:bg-gray-100 rounded-xl text-sm"><i class="fas fa-check-double mr-3 text-blue-900"></i>Registrar Frequ√™ncia</button>
            <button onclick="switchTab('analysis')" class="w-full text-left p-3 hover:bg-gray-100 rounded-xl text-sm"><i class="fas fa-hand-holding-heart mr-3 text-blue-900"></i>Resgate e Alertas</button>
            <button onclick="switchTab('reports')" class="w-full text-left p-3 hover:bg-gray-100 rounded-xl text-sm"><i class="fas fa-file-contract mr-3 text-blue-900"></i>Relat√≥rios Estrat√©gicos</button>
            <button id="btn-admin-view" onclick="switchTab('admin-users')" class="hidden w-full text-left p-3 hover:bg-gray-100 rounded-xl text-sm"><i class="fas fa-users-cog mr-3 text-blue-900"></i>Gerenciar Logins</button>
            <hr>
            <button onclick="logout()" class="w-full text-left p-3 text-red-600 hover:bg-red-50 rounded-xl text-sm font-bold"><i class="fas fa-sign-out-alt mr-3"></i>Sair</button>
        </div>
    </div>

    <main class="container mx-auto p-4 max-w-md">
        
        <!-- Login & First Login (Mantidos) -->
        <div id="view-login" class="py-10 text-center">
            <div class="bg-white p-8 rounded-3xl shadow-sm border space-y-4">
                <i class="fas fa-user-shield text-5xl text-[#002e5d]"></i>
                <h2 class="text-xl font-bold">Acesso</h2>
                <input type="text" id="login-user" placeholder="Usu√°rio" class="w-full p-4 border rounded-2xl outline-none">
                <input type="password" id="login-pass" placeholder="Senha" class="w-full p-4 border rounded-2xl outline-none">
                <button onclick="checkLogin()" class="w-full bg-[#002e5d] text-white p-4 rounded-2xl font-bold">ENTRAR</button>
                <button onclick="switchTab('first-login')" class="text-xs text-blue-900 underline">Primeiro Acesso?</button>
            </div>
        </div>

        <div id="view-first-login" class="hidden py-10 text-center space-y-4">
            <div class="bg-white p-8 rounded-3xl shadow-sm border">
                <h2 class="font-bold mb-4">Ativar Conta</h2>
                <input type="text" id="first-user" placeholder="Usu√°rio Pr√©-autorizado" class="w-full p-4 border rounded-2xl mb-2">
                <input type="password" id="first-pass" placeholder="Nova Senha" class="w-full p-4 border rounded-2xl mb-2">
                <input type="password" id="first-pass-confirm" placeholder="Confirme a Senha" class="w-full p-4 border rounded-2xl mb-4">
                <button onclick="processFirstLogin()" class="w-full bg-green-600 text-white p-4 rounded-2xl font-bold">ATIVAR</button>
            </div>
        </div>

        <!-- DASHBOARD COM HEATMAP -->
        <div id="view-dashboard" class="hidden space-y-4">
            <div class="grid grid-cols-2 gap-3 text-center">
                <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-green-500">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Presentes</p>
                    <p id="stats-present" class="text-3xl font-black text-green-600">0</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-blue-800">
                    <p class="text-[10px] font-bold text-gray-400 uppercase">Total Ala</p>
                    <p id="stats-total" class="text-3xl font-black text-[#002e5d]">0</p>
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm">
                <h3 class="text-[10px] font-bold text-gray-400 uppercase mb-4 text-center">Sa√∫de por Organiza√ß√£o (%)</h3>
                <canvas id="heatmapChart" height="200"></canvas>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm">
                <h3 class="text-[10px] font-bold text-gray-400 uppercase mb-2 text-center">Hist√≥rico Recente</h3>
                <canvas id="attendanceChart" height="120"></canvas>
            </div>
        </div>

        <!-- REGISTRAR FREQU√äNCIA -->
        <div id="view-attendance" class="hidden space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-blue-100 flex items-center justify-between">
                <div>
                    <p class="text-[10px] font-bold text-blue-900 uppercase">Domingo de Refer√™ncia</p>
                    <select id="dateSelect" class="text-sm font-bold bg-transparent outline-none border-none text-gray-700 cursor-pointer"></select>
                </div>
                <i class="fas fa-calendar-alt text-blue-800 text-xl"></i>
            </div>
            <div class="flex overflow-x-auto gap-2 pb-2 no-scrollbar" id="orgFilters"></div>
            <input type="text" id="searchMember" placeholder="üîç Buscar nome..." class="w-full p-4 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
            <div id="memberList" class="space-y-2"></div>
        </div>

        <!-- RELAT√ìRIOS ESTRAT√âGICOS -->
        <div id="view-reports" class="hidden space-y-6">
            <div class="bg-[#002e5d] text-white p-4 rounded-2xl shadow-md">
                <h2 class="font-bold text-sm uppercase tracking-widest"><i class="fas fa-brain mr-2"></i>Intelig√™ncia Pastoral</h2>
                <p class="text-[10px] opacity-80">Identificando padr√µes para o Conselho de Ala</p>
            </div>

            <!-- Sinal Amarelo -->
            <section class="space-y-3">
                <h3 class="text-xs font-bold text-gray-500 uppercase"><i class="fas fa-exclamation-circle text-yellow-500 mr-2"></i>Sinal Amarelo (Frequ√™ncia em Queda)</h3>
                <div id="report-yellow" class="space-y-2"></div>
            </section>

            <!-- Fam√≠lias -->
            <section class="space-y-3">
                <h3 class="text-xs font-bold text-gray-500 uppercase"><i class="fas fa-users text-blue-500 mr-2"></i>Aus√™ncias por Fam√≠lia</h3>
                <div id="report-family" class="space-y-2 text-xs"></div>
            </section>

            <!-- Reten√ß√£o -->
            <section class="space-y-3">
                <h3 class="text-xs font-bold text-gray-500 uppercase"><i class="fas fa-seedling text-green-500 mr-2"></i>Reten√ß√£o (Novos e Conversos)</h3>
                <div id="report-retention" class="space-y-2"></div>
            </section>
        </div>

        <!-- RESGATE (AUSENTES +21 DIAS) -->
        <div id="view-analysis" class="hidden space-y-4">
            <h2 class="text-center font-bold text-orange-600 uppercase text-xs tracking-widest"><i class="fas fa-bullhorn mr-2"></i>Foco de Resgate (+21 dias)</h2>
            <div id="missingList" class="space-y-3"></div>
        </div>

        <!-- NOVO MEMBRO (COM NOVOS CAMPOS) -->
        <div id="view-add" class="hidden">
            <div class="bg-white p-6 rounded-3xl shadow-sm border space-y-4">
                <h2 class="font-bold text-center text-xs uppercase text-gray-400">Novo Cadastro</h2>
                <input type="text" id="newName" placeholder="NOME COMPLETO" class="w-full p-4 border rounded-2xl uppercase text-sm">
                <input type="text" id="newFamily" placeholder="SOBRENOME DA FAM√çLIA" class="w-full p-4 border rounded-2xl uppercase text-sm">
                <div class="grid grid-cols-2 gap-2">
                    <select id="newOrg" class="p-4 border rounded-2xl bg-gray-50 text-[10px] font-bold">
                        <option value="Qu√≥rum de √âlderes">√âLDERES</option>
                        <option value="Sociedade de Socorro">SOCORRO</option>
                        <option value="Mo√ßas">MO√áAS</option>
                        <option value="Rapazes">RAPAZES</option>
                        <option value="Prim√°ria">PRIM√ÅRIA</option>
                        <option value="Visitante">VISITANTE</option>
                    </select>
                    <select id="newCat" class="p-4 border rounded-2xl bg-gray-50 text-[10px] font-bold">
                        <option value="Membro">MEMBRO</option>
                        <option value="Rec√©m-Converso">REC√âM-CONVERSO</option>
                        <option value="Novo Morador">NOVO MORADOR</option>
                    </select>
                </div>
                <button onclick="addMember()" class="w-full bg-[#002e5d] text-white p-4 rounded-2xl font-bold">CADASTRAR</button>
            </div>
        </div>

        <!-- GERENCIAR LOGINS -->
        <div id="view-admin-users" class="hidden space-y-4">
            <div id="users-list" class="space-y-2"></div>
            <button onclick="switchTab('add-user-form')" class="w-full p-4 bg-gray-200 rounded-2xl font-bold text-xs">AUTORIZAR NOVO LOGIN</button>
        </div>

        <!-- MODAL EDITAR MEMBRO -->
        <div id="memberEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 space-y-4 shadow-2xl">
                <h3 class="font-bold border-b pb-2 uppercase text-xs text-gray-400">Editar Perfil</h3>
                <input type="text" id="edit-member-name" class="w-full p-3 border rounded-xl uppercase text-sm">
                <input type="text" id="edit-member-family" placeholder="FAM√çLIA" class="w-full p-3 border rounded-xl uppercase text-sm">
                <div class="grid grid-cols-2 gap-2">
                    <select id="edit-member-org" class="p-3 border rounded-xl bg-gray-50 text-[10px]">
                        <option value="Qu√≥rum de √âlderes">√âLDERES</option><option value="Sociedade de Socorro">SOCORRO</option>
                        <option value="Mo√ßas">MO√áAS</option><option value="Rapazes">RAPAZES</option>
                        <option value="Prim√°ria">PRIM√ÅRIA</option><option value="Visitante">VISITANTE</option>
                    </select>
                    <select id="edit-member-cat" class="p-3 border rounded-xl bg-gray-50 text-[10px]">
                        <option value="Membro">MEMBRO</option><option value="Rec√©m-Converso">REC√âM-CONVERSO</option><option value="Novo Morador">NOVO MORADOR</option>
                    </select>
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="deleteMemberAction()" class="flex-1 bg-red-100 text-red-600 p-3 rounded-xl font-bold text-[10px]">EXCLUIR</button>
                    <button onclick="saveMemberAction()" class="flex-[2] bg-blue-900 text-white p-3 rounded-xl font-bold text-[10px]">SALVAR</button>
                </div>
                <button onclick="closeMemberEdit()" class="w-full text-xs text-gray-400">Cancelar</button>
            </div>
        </div>

    </main>

    <!-- Menu Inferior -->
    <nav id="nav-bar" class="hidden fixed bottom-0 w-full bg-white border-t flex justify-around py-3 shadow-2xl z-50">
        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="flex flex-col items-center gap-1 text-gray-400"><i class="fas fa-home text-xl"></i><span class="text-[10px]">In√≠cio</span></button>
        <button onclick="switchTab('attendance')" id="nav-attendance" class="flex flex-col items-center gap-1 text-gray-400"><i class="fas fa-check-double text-xl"></i><span class="text-[10px]">Registrar</span></button>
        <button onclick="switchTab('analysis')" id="nav-analysis" class="flex flex-col items-center gap-1 text-gray-400"><i class="fas fa-hand-holding-heart text-xl"></i><span class="text-[10px]">Resgate</span></button>
        <button onclick="switchTab('reports')" id="nav-reports" class="flex flex-col items-center gap-1 text-gray-400"><i class="fas fa-file-contract text-xl"></i><span class="text-[10px]">Relat√≥rios</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy, setDoc, deleteDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAaEKx9n4N847WW97FhfZxLZYtsa5cTsE0",
          authDomain: "frequencia-da-ala.firebaseapp.com",
          projectId: "frequencia-da-ala",
          storageBucket: "frequencia-da-ala.firebasestorage.app",
          messagingSenderId: "823110082594",
          appId: "1:823110082594:web:525d38b65a5ab74ec9ea7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentUser = JSON.parse(localStorage.getItem('user_data')) || null;
        let members = []; let allAppUsers = []; let attendanceHistory = {};
        let currentFilter = 'TODOS'; let chartInstance = null; let heatmapInstance = null;
        let selectedDate = new Date().toISOString().split('T')[0];
        let memberIdEditing = null;

        // Gerar domingos (√∫ltimos 3 meses)
        const dateSelect = document.getElementById('dateSelect');
        const domingosISO = [];
        for(let i=0; i<12; i++) {
            let d = new Date(); d.setDate(d.getDate() - (d.getDay() + (7 * i)) % 84);
            let iso = d.toISOString().split('T')[0];
            domingosISO.push(iso);
            dateSelect.innerHTML += `<option value="${iso}">${i==0?'HOJE':iso.split('-')[2]+'/'+iso.split('-')[1]} - Domingo</option>`;
        }
        selectedDate = dateSelect.value;

        // --- AUTH (Mantido) ---
        window.checkLogin = async () => {
            const u = document.getElementById('login-user').value.toLowerCase().trim();
            const p = document.getElementById('login-pass').value.trim();
            const q = query(collection(db, "usuarios"), where("username", "==", u), where("password", "==", p));
            const snap = await getDocs(q);
            if (!snap.empty) {
                const d = snap.docs[0].data(); d.id = snap.docs[0].id;
                localStorage.setItem('user_data', JSON.stringify(d));
                currentUser = d; startApp();
            } else alert("Erro!");
        };
        window.logout = () => { localStorage.removeItem('user_data'); location.reload(); };

        function startApp() {
            if(!currentUser) return;
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('nav-bar').classList.remove('hidden');
            document.getElementById('header-info').classList.remove('hidden');
            document.getElementById('menu-btn').classList.remove('hidden');
            document.getElementById('header-login-title').classList.add('hidden');
            document.getElementById('user-first-name').innerText = currentUser.name.split(' ')[0];
            document.getElementById('menu-user-name').innerText = currentUser.name;
            document.getElementById('menu-user-role').innerText = currentUser.role;
            if(currentUser.role === 'admin') document.getElementById('btn-admin-view').classList.remove('hidden');
            switchTab('dashboard'); listenData();
        }

        function listenData() {
            onSnapshot(query(collection(db, "membros"), orderBy("name")), (snap) => {
                members = snap.docs.map(d => ({id: d.id, ...d.data()})); render(); calculateReports();
            });
            onSnapshot(collection(db, "historico"), (snap) => {
                attendanceHistory = {}; snap.docs.forEach(d => attendanceHistory[d.id] = d.data().presents || []);
                updateCharts(); render(); calculateReports();
            });
            onSnapshot(collection(db, "usuarios"), (snap) => {
                allAppUsers = snap.docs.map(d => ({id: d.id, ...d.data()}));
            });
        }

        // --- FUN√á√ïES DE REGISTRO ---
        window.togglePresence = async (memberId, memberName) => {
            const hRef = doc(db, "historico", selectedDate);
            let cur = attendanceHistory[selectedDate] || [];
            if(cur.includes(memberId)) {
                if(!confirm(`Remover presen√ßa de ${memberName}?`)) return;
                cur = cur.filter(i => i !== memberId);
            } else {
                cur.push(memberId);
                await updateDoc(doc(db, "membros", memberId), { lastAttended: selectedDate });
            }
            await setDoc(hRef, { presents: cur });
        };

        window.addMember = async () => {
            const name = document.getElementById('newName').value.trim().toUpperCase();
            const family = document.getElementById('newFamily').value.trim().toUpperCase();
            const org = document.getElementById('newOrg').value;
            const cat = document.getElementById('newCat').value;
            if(!name) return;
            await addDoc(collection(db, "membros"), { name, familia: family || 'N√ÉO INFORMADA', org, categoria: cat, lastAttended: "2024-01-01" });
            document.getElementById('newName').value = ""; document.getElementById('newFamily').value = ""; switchTab('attendance');
        };

        // --- INTELIG√äNCIA E RELAT√ìRIOS ---
        function calculateReports() {
            const yellowList = document.getElementById('report-yellow');
            const familyList = document.getElementById('report-family');
            const retentionList = document.getElementById('report-retention');
            yellowList.innerHTML = ''; familyList.innerHTML = ''; retentionList.innerHTML = '';

            const last4Dom = domingosISO.slice(0, 4);
            const prev4Dom = domingosISO.slice(4, 8);
            const families = {};

            members.forEach(m => {
                if(m.org === 'Visitante') return;

                // 1. Sinal Amarelo
                let freqLast = last4Dom.filter(d => (attendanceHistory[d] || []).includes(m.id)).length;
                let freqPrev = prev4Dom.filter(d => (attendanceHistory[d] || []).includes(m.id)).length;
                if(freqPrev >= 3 && freqLast <= 1) {
                    yellowList.innerHTML += `<div class="bg-yellow-50 p-3 rounded-xl border-l-4 border-yellow-400 flex justify-between items-center text-xs"><span><b>${m.name}</b><br>Freq. caiu de ${freqPrev}/4 para ${freqLast}/4</span><i class="fas fa-chart-line-down text-yellow-600"></i></div>`;
                }

                // 2. Agrupamento Familiar
                const fam = m.familia || 'SEM FAM√çLIA';
                if(!families[fam]) families[fam] = { total: 0, present: 0 };
                families[fam].total++;
                if((attendanceHistory[selectedDate] || []).includes(m.id)) families[fam].present++;

                // 3. Reten√ß√£o
                if(m.categoria === 'Rec√©m-Converso' || m.categoria === 'Novo Morador') {
                    const isP = (attendanceHistory[selectedDate] || []).includes(m.id);
                    retentionList.innerHTML += `<div class="p-3 rounded-xl border ${isP?'border-green-200 bg-green-50':'border-red-200 bg-red-50'} text-xs flex justify-between items-center"><span><b>${m.name}</b> (${m.categoria})</span> <i class="fas ${isP?'fa-check text-green-600':'fa-times text-red-600'}"></i></div>`;
                }
            });

            // Renderizar Fam√≠lias com problemas
            Object.keys(families).forEach(f => {
                if(families[f].present === 0) {
                    familyList.innerHTML += `<div class="bg-white p-3 rounded-xl border flex justify-between items-center shadow-sm"><span>Fam√≠lia <b>${f}</b></span> <span class="bg-red-100 text-red-700 px-2 py-1 rounded text-[10px]">0 de ${families[f].total} presentes</span></div>`;
                }
            });
        }

        // --- GR√ÅFICOS ---
        function updateCharts() {
            // Hist√≥rico Linear
            const ctx1 = document.getElementById('attendanceChart').getContext('2d');
            const dates = domingosISO.slice(0, 5).reverse();
            const counts = dates.map(d => (attendanceHistory[d] || []).length);
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx1, { type: 'line', data: { labels: dates.map(d=>d.split('-')[2]+'/'+d.split('-')[1]), datasets: [{ data: counts, borderColor: '#002e5d', fill: true, tension: 0.4 }] }, options: { plugins: { legend: false }, scales: { y: { beginAtZero: true } } } });

            // Heatmap por Organiza√ß√£o
            const ctx2 = document.getElementById('heatmapChart').getContext('2d');
            const orgs = ['Qu√≥rum de √âlderes', 'Sociedade de Socorro', 'Mo√ßas', 'Rapazes', 'Prim√°ria'];
            const stats = orgs.map(o => {
                const total = members.filter(m => m.org === o).length;
                const pres = members.filter(m => m.org === o && (attendanceHistory[selectedDate] || []).includes(m.id)).length;
                return total > 0 ? Math.round((pres/total)*100) : 0;
            });
            if(heatmapInstance) heatmapInstance.destroy();
            heatmapInstance = new Chart(ctx2, { type: 'bar', data: { labels: ['√âLD', 'SOC', 'MO√á', 'RAP', 'PRI'], datasets: [{ data: stats, backgroundColor: ['#1e40af','#be185d','#059669','#d97706','#7c3aed'] }] }, options: { indexAxis: 'y', plugins: { legend: false }, scales: { x: { max: 100 } } } });
        }

        // --- INTERFACE (MANTIDA) ---
        window.render = () => {
            const s = document.getElementById('searchMember').value.toLowerCase();
            const list = document.getElementById('memberList');
            const missList = document.getElementById('missingList');
            const curP = attendanceHistory[selectedDate] || [];
            list.innerHTML = ''; missList.innerHTML = '';
            let pC = 0; let tC = 0;

            members.forEach(m => {
                const isP = curP.includes(m.id);
                if(m.org !== 'Visitante') { tC++; if(isP) pC++; }

                const diff = Math.floor((new Date() - new Date(m.lastAttended)) / (1000*60*60*24));
                if(m.org !== 'Visitante' && diff > 21) {
                    missList.innerHTML += `<div class="bg-white p-4 rounded-xl border-r-4 border-orange-500 flex justify-between items-center shadow-sm"><div><p class="font-bold text-sm">${m.name}</p><p class="text-[9px] font-bold text-orange-600 uppercase">${m.familia} ‚Ä¢ ${Math.floor(diff/7)} SEMANAS AUSENTE</p></div><a href="https://wa.me/?text=Ol√°, sentimos sua falta na reuni√£o sacramental!" class="text-green-500"><i class="fab fa-whatsapp text-2xl"></i></a></div>`;
                }

                if((currentFilter === 'TODOS' || m.org === currentFilter) && m.name.toLowerCase().includes(s)) {
                    list.innerHTML += `<div class="flex items-center gap-3 bg-white p-4 rounded-xl shadow-sm border-l-4 ${isP ? 'border-green-500' : 'border-gray-200'}">
                        <input type="checkbox" ${isP ? 'checked' : ''} onchange="togglePresence('${m.id}', '${m.name}')" class="rounded-full w-5 h-5 text-blue-900">
                        <div onclick="togglePresence('${m.id}', '${m.name}')" class="flex-1">
                            <p class="font-bold text-sm text-gray-700 leading-tight">${m.name}</p>
                            <p class="text-[9px] text-gray-400 font-bold uppercase">${m.familia} ‚Ä¢ ${m.org}</p>
                        </div>
                        <button onclick="openMemberEdit('${m.id}')" class="text-gray-300 px-2"><i class="fas fa-edit text-sm"></i></button>
                    </div>`;
                }
            });
            document.getElementById('stats-present').innerText = pC;
            document.getElementById('stats-total').innerText = tC;
        };

        window.openMemberEdit = (id) => {
            const m = members.find(x => x.id === id); memberIdEditing = id;
            document.getElementById('edit-member-name').value = m.name;
            document.getElementById('edit-member-family').value = m.familia || '';
            document.getElementById('edit-member-org').value = m.org;
            document.getElementById('edit-member-cat').value = m.categoria || 'Membro';
            document.getElementById('memberEditModal').classList.remove('hidden');
        };
        window.closeMemberEdit = () => document.getElementById('memberEditModal').classList.add('hidden');
        window.saveMemberAction = async () => {
            await updateDoc(doc(db, "membros", memberIdEditing), { 
                name: document.getElementById('edit-member-name').value.toUpperCase(), 
                familia: document.getElementById('edit-member-family').value.toUpperCase(), 
                org: document.getElementById('edit-member-org').value,
                categoria: document.getElementById('edit-member-cat').value
            });
            closeMemberEdit();
        };
        window.deleteMemberAction = async () => { if(confirm("Excluir?")) { await deleteDoc(doc(db, "membros", memberIdEditing)); closeMemberEdit(); } };

        window.toggleMenu = () => { document.getElementById('side-menu').classList.toggle('menu-open'); document.getElementById('menu-overlay').classList.toggle('hidden'); };
        window.switchTab = (tab) => {
            document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('text-[#002e5d]', 'text-gray-400'));
            if(document.getElementById(`nav-${tab}`)) document.getElementById(`nav-${tab}`).classList.replace('text-gray-400', 'text-[#002e5d]');
            if(document.getElementById('side-menu').classList.contains('menu-open')) toggleMenu();
            window.scrollTo(0,0);
        };

        window.setFilter = (f) => { currentFilter = f; document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active')); document.getElementById('pill-'+(f.replace(/\s+/g, ''))).classList.add('active'); render(); };
        dateSelect.addEventListener('change', (e) => { selectedDate = e.target.value; render(); updateCharts(); calculateReports(); });
        document.getElementById('searchMember').addEventListener('input', render);

        // Render Filtros
        const filterArea = document.getElementById('orgFilters');
        ['TODOS', 'Qu√≥rum de √âlderes', 'Sociedade de Socorro', 'Mo√ßas', 'Rapazes', 'Prim√°ria', 'Visitante'].forEach(o => {
            const id = o.replace(/\s+/g, '');
            filterArea.innerHTML += `<button onclick="setFilter('${o}')" class="filter-pill ${o=='TODOS'?'active':''} px-4 py-2 rounded-full border bg-white text-[10px] font-bold whitespace-nowrap shadow-sm" id="pill-${id}">${o}</button>`;
        });

        if(currentUser) startApp(); else switchTab('login');
    </script>
</body>
</html>
